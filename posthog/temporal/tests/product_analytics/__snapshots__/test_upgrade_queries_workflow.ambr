# serializer version: 1
# name: TestUpgradeQueriesWorkflow.test_get_insights_to_migrate_activity
  '''
  WITH latest(kind, v_latest) AS (
                                  VALUES ('InsightVizNode',
                                          4),('TrendsQuery',
                                              6),('EventsNode',
                                                  8))
  SELECT DISTINCT i.id
  FROM posthog_dashboarditem AS i
  CROSS JOIN latest AS l
  WHERE jsonb_path_exists(i.query, format($$
                  $.** ? (
                      @.kind == "%s" &&    /* kind matches */
                      (
                          !exists(@.v)     /* no v property */
                          || @.v == null   /* or v:null */
                          || @.v <= %s     /* or version â‰¤ latest */
                      )
                  )
                  $$, l.kind, l.v_latest)::jsonpath)
  LIMIT 100;
  '''
# ---
